<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_PIX_Bitfinex_Completo" targetNamespace="http://example.com/bpmn/pix-bitfinex" exporter="bpmn-js (https://demo.bpmn.io)" exporterVersion="18.6.1">
  <bpmn:process id="Process_PIX_Bitfinex" isExecutable="true">
    <bpmn:laneSet id="LaneSet_Main">
      <bpmn:lane id="Lane_Sistema" name="Sistema">
        <bpmn:flowNodeRef>ServiceTask_GerarQRCodeAsaas</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ServiceTask_AtualizarSaldo</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ServiceTask_ConsultarSaldo</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ServiceTask_CalcularRetencao</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ServiceTask_ExecutarTransferenciaBitfinex</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ServiceTask_RegistrarTransacaoSaida</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>IntermediateCatchEvent_PagamentoWebhook</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ExclusiveGateway_VerificarSaldo</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_Usuario" name="Usuário">
        <bpmn:flowNodeRef>UserTask_SolicitarRecebimentoPIX</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>UserTask_SolicitarTransferencia</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>UserTask_ConfirmarValor</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ServiceTask_NotificarSaldoInsuficiente</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>StartEvent_SolicitacaoRecebimento</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>EndEvent_TransferenciaRealizada</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>EndEvent_TransferenciaCancelada</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>
    <bpmn:startEvent id="StartEvent_SolicitacaoRecebimento" name="Solicitação de Recebimento" />
    <bpmn:sequenceFlow id="Flow_Start_To_SolicitarPIX" sourceRef="StartEvent_SolicitacaoRecebimento" targetRef="UserTask_SolicitarRecebimentoPIX" />
    <bpmn:userTask id="UserTask_SolicitarRecebimentoPIX" name="Solicitação de Recebimento" />
    <bpmn:sequenceFlow id="Flow_SolicitarPIX_To_GerarQR" sourceRef="UserTask_SolicitarRecebimentoPIX" targetRef="ServiceTask_GerarQRCodeAsaas" />
    <bpmn:serviceTask id="ServiceTask_GerarQRCodeAsaas" name="Chamar API Asaas para Criar QR Code" />
    <bpmn:sequenceFlow id="Flow_GerarQR_To_Webhook" sourceRef="ServiceTask_GerarQRCodeAsaas" targetRef="IntermediateCatchEvent_PagamentoWebhook" />
    <bpmn:intermediateCatchEvent id="IntermediateCatchEvent_PagamentoWebhook" name="Aguardar Notificação de Pagamento (Webhook)">
      <bpmn:messageEventDefinition id="MessageEventDef_PagamentoConfirmado" />
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="Flow_Webhook_To_AtualizarSaldo" sourceRef="IntermediateCatchEvent_PagamentoWebhook" targetRef="ServiceTask_AtualizarSaldo" />
    <bpmn:serviceTask id="ServiceTask_AtualizarSaldo" name="Atualizar Saldo no Banco de Dados" />
    <bpmn:sequenceFlow id="Flow_AtualizarSaldo_To_ConsultarSaldo" sourceRef="ServiceTask_AtualizarSaldo" targetRef="ServiceTask_ConsultarSaldo" />
    <bpmn:userTask id="UserTask_SolicitarTransferencia" name="Solicitação de Transferência">
      <bpmn:outgoing>Flow_0rf3hg7</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:sequenceFlow id="Flow_ConsultarSaldo_To_SolicitarTransferencia" sourceRef="ServiceTask_ConsultarSaldo" targetRef="UserTask_SolicitarTransferencia" />
    <bpmn:userTask id="UserTask_ConfirmarValor" name="Informar Valor e Confirmar">
      <bpmn:incoming>Flow_0rf3hg7</bpmn:incoming>
    </bpmn:userTask>
    <bpmn:sequenceFlow id="Flow_Confirmar_To_ConsultarSaldo" sourceRef="UserTask_ConfirmarValor" targetRef="ServiceTask_ConsultarSaldo" />
    <bpmn:serviceTask id="ServiceTask_ConsultarSaldo" name="Consultar Saldo no Banco de Dados" />
    <bpmn:sequenceFlow id="Flow_ConsultarSaldo_To_Gateway" sourceRef="ServiceTask_ConsultarSaldo" targetRef="ExclusiveGateway_VerificarSaldo" />
    <bpmn:exclusiveGateway id="ExclusiveGateway_VerificarSaldo" name="Saldo é suficiente?">
      <bpmn:outgoing>Flow_0bi5qsz</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_Gateway_Sim" sourceRef="ExclusiveGateway_VerificarSaldo" targetRef="ServiceTask_CalcularRetencao">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${saldo &gt;= valorSolicitado}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:serviceTask id="ServiceTask_CalcularRetencao" name="Calcular Retenção de 7%" />
    <bpmn:sequenceFlow id="Flow_CalcularRetencao_To_Transferir" sourceRef="ServiceTask_CalcularRetencao" targetRef="ServiceTask_ExecutarTransferenciaBitfinex" />
    <bpmn:serviceTask id="ServiceTask_ExecutarTransferenciaBitfinex" name="Chamar API para Executar Transferência" />
    <bpmn:sequenceFlow id="Flow_Transferir_To_Registrar" sourceRef="ServiceTask_ExecutarTransferenciaBitfinex" targetRef="ServiceTask_RegistrarTransacaoSaida" />
    <bpmn:serviceTask id="ServiceTask_RegistrarTransacaoSaida" name="Registrar Transação de Saída no BD" />
    <bpmn:sequenceFlow id="Flow_Registrar_To_FimSucesso" sourceRef="ServiceTask_RegistrarTransacaoSaida" targetRef="EndEvent_TransferenciaRealizada" />
    <bpmn:endEvent id="EndEvent_TransferenciaRealizada" name="Transferência Realizada" />
    <bpmn:serviceTask id="ServiceTask_NotificarSaldoInsuficiente" name="Notificar Usuário sobre Saldo Insuficiente">
      <bpmn:incoming>Flow_0bi5qsz</bpmn:incoming>
      <bpmn:outgoing>Flow_Notificar_To_FimFalha</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:endEvent id="EndEvent_TransferenciaCancelada" name="Transferência Cancelada">
      <bpmn:incoming>Flow_Notificar_To_FimFalha</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_0bi5qsz" sourceRef="ExclusiveGateway_VerificarSaldo" targetRef="ServiceTask_NotificarSaldoInsuficiente" />
    <bpmn:sequenceFlow id="Flow_0rf3hg7" sourceRef="UserTask_SolicitarTransferencia" targetRef="UserTask_ConfirmarValor" />
    <bpmn:sequenceFlow id="Flow_Notificar_To_FimFalha" sourceRef="ServiceTask_NotificarSaldoInsuficiente" targetRef="EndEvent_TransferenciaCancelada" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_PIX_Bitfinex">
    <bpmndi:BPMNPlane id="BPMNPlane_PIX_Bitfinex" bpmnElement="Process_PIX_Bitfinex">
      <bpmndi:BPMNShape id="LaneShape_Sistema" bpmnElement="Lane_Sistema" isHorizontal="true">
        <dc:Bounds x="160" y="380" width="1140" height="320" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="LaneShape_Usuario" bpmnElement="Lane_Usuario" isHorizontal="true">
        <dc:Bounds x="160" y="90" width="1140" height="290" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="StartEvent_SolicitacaoRecebimento_di" bpmnElement="StartEvent_SolicitacaoRecebimento">
        <dc:Bounds x="202" y="182" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="186" y="218" width="69" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="UserTask_SolicitarRecebimentoPIX_di" bpmnElement="UserTask_SolicitarRecebimentoPIX">
        <dc:Bounds x="326" y="162" width="120" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_GerarQRCodeAsaas_di" bpmnElement="ServiceTask_GerarQRCodeAsaas">
        <dc:Bounds x="250" y="420" width="140" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_AtualizarSaldo_di" bpmnElement="ServiceTask_AtualizarSaldo">
        <dc:Bounds x="490" y="420" width="120" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_TransferenciaRealizada_di" bpmnElement="EndEvent_TransferenciaRealizada">
        <dc:Bounds x="1252" y="272" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1237" y="234.5" width="66" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="IntermediateCatchEvent_PagamentoWebhook_di" bpmnElement="IntermediateCatchEvent_PagamentoWebhook">
        <dc:Bounds x="422" y="592" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="407" y="632" width="70" height="53" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_ConsultarSaldo_di" bpmnElement="ServiceTask_ConsultarSaldo">
        <dc:Bounds x="700" y="470" width="120" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ExclusiveGateway_VerificarSaldo_di" bpmnElement="ExclusiveGateway_VerificarSaldo" isMarkerVisible="true">
        <dc:Bounds x="940" y="430" width="40" height="40" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="933.5" y="480" width="53" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="UserTask_SolicitarTransferencia_di" bpmnElement="UserTask_SolicitarTransferencia">
        <dc:Bounds x="510" y="110" width="120" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="UserTask_ConfirmarValor_di" bpmnElement="UserTask_ConfirmarValor">
        <dc:Bounds x="510" y="250" width="120" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_NotificarSaldoInsuficiente_di" bpmnElement="ServiceTask_NotificarSaldoInsuficiente">
        <dc:Bounds x="910" y="160" width="120" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_TransferenciaCancelada_di" bpmnElement="EndEvent_TransferenciaCancelada">
        <dc:Bounds x="1118" y="122" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1103" y="84.5" width="66" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_CalcularRetencao_di" bpmnElement="ServiceTask_CalcularRetencao">
        <dc:Bounds x="1076" y="420" width="120" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_ExecutarTransferenciaBitfinex_di" bpmnElement="ServiceTask_ExecutarTransferenciaBitfinex">
        <dc:Bounds x="1076" y="510" width="120" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_RegistrarTransacaoSaida_di" bpmnElement="ServiceTask_RegistrarTransacaoSaida">
        <dc:Bounds x="1076" y="610" width="120" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_Start_To_SolicitarPIX_di" bpmnElement="Flow_Start_To_SolicitarPIX">
        <di:waypoint x="238" y="200" />
        <di:waypoint x="326" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_SolicitarPIX_To_GerarQR_di" bpmnElement="Flow_SolicitarPIX_To_GerarQR">
        <di:waypoint x="446" y="232" />
        <di:waypoint x="446" y="369" />
        <di:waypoint x="250" y="369" />
        <di:waypoint x="250" y="430" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ConsultarSaldo_To_SolicitarTransferencia_di" bpmnElement="Flow_ConsultarSaldo_To_SolicitarTransferencia">
        <di:waypoint x="760" y="470" />
        <di:waypoint x="760" y="150" />
        <di:waypoint x="630" y="150" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Confirmar_To_ConsultarSaldo_di" bpmnElement="Flow_Confirmar_To_ConsultarSaldo">
        <di:waypoint x="630" y="290" />
        <di:waypoint x="760" y="290" />
        <di:waypoint x="760" y="470" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Gateway_Sim_di" bpmnElement="Flow_Gateway_Sim">
        <di:waypoint x="980" y="450" />
        <di:waypoint x="1076" y="450" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_CalcularRetencao_To_Transferir_di" bpmnElement="Flow_CalcularRetencao_To_Transferir">
        <di:waypoint x="1136" y="480" />
        <di:waypoint x="1136" y="510" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Registrar_To_FimSucesso_di" bpmnElement="Flow_Registrar_To_FimSucesso">
        <di:waypoint x="1196" y="640" />
        <di:waypoint x="1226" y="640" />
        <di:waypoint x="1226" y="290" />
        <di:waypoint x="1252" y="290" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Notificar_To_FimFalha_di" bpmnElement="Flow_Notificar_To_FimFalha">
        <di:waypoint x="1030" y="190" />
        <di:waypoint x="1136" y="190" />
        <di:waypoint x="1136" y="158" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_GerarQR_To_Webhook_di" bpmnElement="Flow_GerarQR_To_Webhook">
        <di:waypoint x="320" y="500" />
        <di:waypoint x="320" y="609" />
        <di:waypoint x="422" y="609" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Webhook_To_AtualizarSaldo_di" bpmnElement="Flow_Webhook_To_AtualizarSaldo">
        <di:waypoint x="458" y="609" />
        <di:waypoint x="550" y="609" />
        <di:waypoint x="550" y="500" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_AtualizarSaldo_To_ConsultarSaldo_di" bpmnElement="Flow_AtualizarSaldo_To_ConsultarSaldo">
        <di:waypoint x="610" y="460" />
        <di:waypoint x="655" y="460" />
        <di:waypoint x="655" y="510" />
        <di:waypoint x="700" y="510" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ConsultarSaldo_To_Gateway_di" bpmnElement="Flow_ConsultarSaldo_To_Gateway">
        <di:waypoint x="820" y="510" />
        <di:waypoint x="905" y="510" />
        <di:waypoint x="905" y="450" />
        <di:waypoint x="940" y="450" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Transferir_To_Registrar_di" bpmnElement="Flow_Transferir_To_Registrar">
        <di:waypoint x="1136" y="570" />
        <di:waypoint x="1136" y="610" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0bi5qsz_di" bpmnElement="Flow_0bi5qsz">
        <di:waypoint x="960" y="430" />
        <di:waypoint x="960" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0rf3hg7_di" bpmnElement="Flow_0rf3hg7">
        <di:waypoint x="570" y="190" />
        <di:waypoint x="570" y="250" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
